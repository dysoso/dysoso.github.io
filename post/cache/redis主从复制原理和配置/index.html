<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>[数据库] Redis主从复制原理和配置 - Never Give Up</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="ZhangKQ" /><meta name="description" content="一、 Redis主从复制原理 参考文档 文档地址： https://www.cnblogs.com/daofaziran/p/10978628.html 配置说明: https://www.cnblogs.com/kreo/p/4423362.html 全量同步 Redis全量复制一般发生在Slave初始化阶段，这时Slave需要将Ma" /><meta name="keywords" content="数据库, redis, cache, no sql, 主从复制" />






<meta name="generator" content="Hugo 0.92.0 with theme even" />


<link rel="canonical" href="https://blog.nevergiveup.tech/post/cache/redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.b5a744db6de49a86cadafb3b70f555ab443f83c307a483402259e94726b045ff.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="[数据库] Redis主从复制原理和配置" />
<meta property="og:description" content="一、 Redis主从复制原理 参考文档 文档地址： https://www.cnblogs.com/daofaziran/p/10978628.html 配置说明: https://www.cnblogs.com/kreo/p/4423362.html 全量同步 Redis全量复制一般发生在Slave初始化阶段，这时Slave需要将Ma" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.nevergiveup.tech/post/cache/redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-08-07T15:37:56+08:00" />
<meta property="article:modified_time" content="2019-08-07T15:37:56+08:00" />

<meta itemprop="name" content="[数据库] Redis主从复制原理和配置">
<meta itemprop="description" content="一、 Redis主从复制原理 参考文档 文档地址： https://www.cnblogs.com/daofaziran/p/10978628.html 配置说明: https://www.cnblogs.com/kreo/p/4423362.html 全量同步 Redis全量复制一般发生在Slave初始化阶段，这时Slave需要将Ma"><meta itemprop="datePublished" content="2019-08-07T15:37:56+08:00" />
<meta itemprop="dateModified" content="2019-08-07T15:37:56+08:00" />
<meta itemprop="wordCount" content="7912">
<meta itemprop="keywords" content="数据库,redis,cache,no sql,主从复制," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[数据库] Redis主从复制原理和配置"/>
<meta name="twitter:description" content="一、 Redis主从复制原理 参考文档 文档地址： https://www.cnblogs.com/daofaziran/p/10978628.html 配置说明: https://www.cnblogs.com/kreo/p/4423362.html 全量同步 Redis全量复制一般发生在Slave初始化阶段，这时Slave需要将Ma"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Never Give Up</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Never Give Up</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">[数据库] Redis主从复制原理和配置</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-08-07 </span>
        <div class="post-category">
            <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"> 数据库 </a>
            <a href="/categories/redis/"> redis </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#一-redis主从复制原理"><strong>一、</strong> <strong>Redis主从复制原理</strong></a>
          <ul>
            <li><a href="#参考文档"><strong>参考文档</strong></a></li>
            <li><a href="#全量同步"><strong>全量同步</strong></a></li>
            <li><a href="#增量同步"><strong>增量同步</strong></a></li>
            <li><a href="#redis主从同步策略"><strong>Redis主从同步策略</strong></a></li>
            <li><a href="#注意点"><strong>注意点</strong></a></li>
            <li><a href="#主从复制的一些特点"><strong>主从复制的一些特点：</strong></a></li>
            <li><a href="#redis大概主从同步是怎么实现的"><strong>Redis大概主从同步是怎么实现的？</strong></a></li>
            <li><a href="#主从同步中需要注意几个问题"><strong>主从同步中需要注意几个问题</strong></a></li>
            <li><a href="#当主服务器不进行持久化时复制的安全性"><strong>当主服务器不进行持久化时复制的安全性</strong></a></li>
            <li><a href="#redis主从复制是如何工作的"><strong>Redis主从复制是如何工作的</strong></a></li>
            <li><a href="#部分重新同步"><strong>部分重新同步</strong></a></li>
            <li><a href="#无磁盘复制"><strong>无磁盘复制</strong></a></li>
            <li><a href="#配置"><strong>配置</strong></a></li>
            <li><a href="#只读从服务器"><strong>只读从服务器</strong></a></li>
            <li><a href="#限制有n个以上从服务器才允许写入"><strong>限制有N个以上从服务器才允许写入</strong></a></li>
          </ul>
        </li>
        <li><a href="#二-redis主从复制配置"><strong>二、</strong> <strong>Redis主从复制配置</strong></a>
          <ul>
            <li><a href="#1参考文档"><strong>1.参考文档</strong></a></li>
            <li><a href="#2主从配置"><strong>2.主从配置</strong></a></li>
            <li><a href="#3一些常用配置"><strong>3.一些常用配置:</strong></a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="一-redis主从复制原理"><strong>一、</strong> <strong>Redis主从复制原理</strong></h2>
<h3 id="参考文档"><strong>参考文档</strong></h3>
<p>文档地址：</p>
<p><a href="https://www.cnblogs.com/daofaziran/p/10978628.html">https://www.cnblogs.com/daofaziran/p/10978628.html</a></p>
<p>配置说明:</p>
<p><a href="https://www.cnblogs.com/kreo/p/4423362.html">https://www.cnblogs.com/kreo/p/4423362.html</a></p>
<h3 id="全量同步"><strong>全量同步</strong></h3>
<p>Redis全量复制一般发生在Slave初始化阶段，这时Slave需要将Master上的所有数据都复制一份。具体步骤如下：</p>
<ul>
<li>
<p>从服务器连接主服务器，发送SYNC命令；</p>
</li>
<li>
<p>主服务器接收到SYNC命名后，开始执行BGSAVE命令生成RDB文件并使用缓冲区记录此后执行的所有写命令；</p>
</li>
<li>
<p>主服务器BGSAVE执行完后，向所有从服务器发送快照文件，并在发送期间继续记录被执行的写命令；</p>
</li>
<li>
<p>从服务器收到快照文件后丢弃所有旧数据，载入收到的快照；</p>
</li>
<li>
<p>主服务器快照发送完毕后开始向从服务器发送缓冲区中的写命令；</p>
</li>
<li>
<p>从服务器完成对快照的载入，开始接收命令请求，并执行来自主服务器缓冲区的写命令</p>
</li>
</ul>
<p><img src="/redis%E4%B8%BB%E4%BB%8E/redis1.png" alt="img"></p>
<h3 id="增量同步"><strong>增量同步</strong></h3>
<p>Redis增量复制是指Slave初始化后开始正常工作时主服务器发生的写操作同步到从服务器的过程。</p>
<p>增量复制的过程主要是主服务器每执行一个写命令就会向从服务器发送相同的写命令，从服务器接收并执行收到的写命令。</p>
<h3 id="redis主从同步策略"><strong>Redis主从同步策略</strong></h3>
<p>主从刚刚连接的时候，进行全量同步；全同步结束后，进行增量同步。当然，如果有需要，slave 在任何时候都可以发起全量同步。redis 策略是，无论如何，首先会尝试进行增量同步，如不成功，要求从机进行全量同步。</p>
<h3 id="注意点"><strong>注意点</strong></h3>
<p>如果多个Slave断线了，需要重启的时候，因为只要Slave启动，就会发送sync请求和主机全量同步，当多个同时出现的时候，可能会导致Master IO剧增宕机。</p>
<p>Redis主从复制的配置十分简单，它可以使从服务器是主服务器的完全拷贝。需要清除Redis主从复制的几点重要内容：</p>
<p>1）Redis使用异步复制。但从Redis 2.8开始，从服务器会周期性的应答从复制流中处理的数据量。</p>
<p>2）一个主服务器可以有多个从服务器。</p>
<p>3）从服务器也可以接受其他从服务器的连接。除了多个从服务器连接到一个主服务器之外，多个从服务器也可以连接到一个从服务器上，形成一个</p>
<p>图状结构。</p>
<p>4）Redis主从复制不阻塞主服务器端。也就是说当若干个从服务器在进行初始同步时，主服务器仍然可以处理请求。</p>
<p>5）主从复制也不阻塞从服务器端。当从服务器进行初始同步时，它使用旧版本的数据来应对查询请求，假设你在redis.conf配置文件是这么配置的。</p>
<p>否则的话，你可以配置当复制流关闭时让从服务器给客户端返回一个错误。但是，当初始同步完成后，需要删除旧的数据集和加载新的数据集，在</p>
<p>这个短暂的时间内，从服务器会阻塞连接进来的请求。</p>
<p>6）主从复制可以用来增强扩展性，使用多个从服务器来处理只读的请求（比如，繁重的排序操作可以放到从服务器去做），也可以简单的用来做数据冗余。</p>
<p>7）使用主从复制可以为主服务器免除把数据写入磁盘的消耗：在主服务器的redis.conf文件中配置“避免保存”（注释掉所有“保存“命令），然后连接一个配</p>
<p>置为“进行保存”的从服务器即可。但是这个配置要确保主服务器不会自动重启（要获得更多信息请阅读下一段）</p>
<h3 id="主从复制的一些特点"><strong>主从复制的一些特点：</strong></h3>
<p>1）采用异步复制；</p>
<p>2）一个主redis可以含有多个从redis；</p>
<p>3）每个从redis可以接收来自其他从redis服务器的连接；</p>
<p>4）主从复制对于主redis服务器来说是非阻塞的，这意味着当从服务器在进行主从复制同步过程中，主redis仍然可以处理外界的访问请求；</p>
<p>5）主从复制对于从redis服务器来说也是非阻塞的，这意味着，即使从redis在进行主从复制过程中也可以接受外界的查询请求，只不过这时候从redis返回的是以前老的数据，</p>
<p>如果你不想这样，那么在启动redis时，可以在配置文件中进行设置，那么从redis在复制同步过程中来自外界的查询请求都会返回错误给客户端；（虽然说主从复制过程中</p>
<p>对于从redis是非阻塞的，但是当从redis从主redis同步过来最新的数据后还需要将新数据加载到内存中，在加载到内存的过程中是阻塞的，在这段时间内的请求将会被阻，</p>
<p>但是即使对于大数据集，加载到内存的时间也是比较多的）；</p>
<p>6）主从复制提高了redis服务的扩展性，避免单个redis服务器的读写访问压力过大的问题，同时也可以给为数据备份及冗余提供一种解决方案；</p>
<p>7）为了编码主redis服务器写磁盘压力带来的开销，可以配置让主redis不在将数据持久化到磁盘，而是通过连接让一个配置的从redis服务器及时的将相关数据持久化到磁盘，</p>
<p>不过这样会存在一个问题，就是主redis服务器一旦重启，因为主redis服务器数据为空，这时候通过主从同步可能导致从redis服务器上的数据也被清空；</p>
<h3 id="redis大概主从同步是怎么实现的"><strong>Redis大概主从同步是怎么实现的？</strong></h3>
<p>全量同步：</p>
<p>master服务器会开启一个后台进程用于将redis中的数据生成一个rdb文件，与此同时，服务器会缓存所有接收到的来自客户端的写命令（包含增、删、改），当后台保存进程</p>
<p>处理完毕后，会将该rdb文件传递给slave服务器，而slave服务器会将rdb文件保存在磁盘并通过读取该文件将数据加载到内存，在此之后master服务器会将在此期间缓存的</p>
<p>命令通过redis传输协议发送给slave服务器，然后slave服务器将这些命令依次作用于自己本地的数据集上最终达到数据的一致性。</p>
<p>部分同步：</p>
<p>从redis 2.8版本以前，并不支持部分同步，当主从服务器之间的连接断掉之后，master服务器和slave服务器之间都是进行全量数据同步，但是从redis 2.8开</p>
<p>始，即使主从连接中途断掉，也不需要进行全量同步，因为从这个版本开始融入了部分同步的概念。部分同步的实现依赖于在master服务器内存中给每个slave服务器维护了</p>
<p>一份同步日志和同步标识，每个slave服务器在跟master服务器进行同步时都会携带自己的同步标识和上次同步的最后位置。当主从连接断掉之后，slave服务器隔断时间</p>
<p>（默认1s）主动尝试和master服务器进行连接，如果从服务器携带的偏移量标识还在master服务器上的同步备份日志中，那么就从slave发送的偏移量开始继续上次的同步</p>
<p>操作，如果slave发送的偏移量已经不再master的同步备份日志中（可能由于主从之间断掉的时间比较长或者在断掉的短暂时间内master服务器接收到大量的写操作），则</p>
<p>必须进行一次全量更新。在部分同步过程中，master会将本地记录的同步备份日志中记录的指令依次发送给slave服务器从而达到数据一致。</p>
<h3 id="主从同步中需要注意几个问题"><strong>主从同步中需要注意几个问题</strong></h3>
<p>1）在上面的全量同步过程中，master会将数据保存在rdb文件中然后发送给slave服务器，但是如果master上的磁盘空间有效怎么办呢？那么此时全部同步对于master来说</p>
<p>将是一份十分有压力的操作了。此时可以通过无盘复制来达到目的，由master直接开启一个socket将rdb文件发送给slave服务器。（无盘复制一般应用在磁盘空间有限但是网</p>
<p>络状态良好的情况下）</p>
<p>2）主从复制结构，一般slave服务器不能进行写操作，但是这不是死的，之所以这样是为了更容易的保证主和各个从之间数据的一致性，如果slave服务器上数据进行了修改，</p>
<p>那么要保证所有主从服务器都能一致，可能在结构上和处理逻辑上更为负责。不过你也可以通过配置文件让从服务器支持写操作。（不过所带来的影响还得自己承担哦。。。）</p>
<p>3）主从服务器之间会定期进行通话，但是如果master上设置了密码，那么如果不给slave设置密码就会导致slave不能跟master进行任何操作，所以如果你的master服务器</p>
<p>上有密码，那么也给slave相应的设置一下密码吧（通过设置配置文件中的masterauth）;</p>
<p>4）关于slave服务器上过期键的处理，由master服务器负责键的过期删除处理，然后将相关删除命令已数据同步的方式同步给slave服务器，slave服务器根据删除命令删除</p>
<p>本地的key。</p>
<h3 id="当主服务器不进行持久化时复制的安全性"><strong>当主服务器不进行持久化时复制的安全性</strong></h3>
<p>在进行主从复制设置时，强烈建议在主服务器上开启持久化，当不能这么做时，比如考虑到延迟的问题，应该将实例配置为避免自动重启。</p>
<p>为什么不持久化的主服务器自动重启非常危险呢？</p>
<p>为了更好的理解这个问题，看下面这个失败的例子，其中主服务器和从服务器中数据库都被删除了。</p>
<p>设置节点A为主服务器，关闭持久化，节点B和C从节点A复制数据。</p>
<p>这时出现了一个崩溃，但Redis具有自动重启系统，重启了进程，因为关闭了持久化，节点重启后只有一个空的数据集。</p>
<p>节点B和C从节点A进行复制，现在节点A是空的，所以节点B和C上的复制数据也会被删除。</p>
<p>当在高可用系统中使用Redis Sentinel，关闭了主服务器的持久化，并且允许自动重启，这种情况是很危险的。</p>
<p>比如主服务器可能在很短的时间就完成了重启，以至于Sentinel都无法检测到这次失败，那么上面说的这种失败的情况就发生了。</p>
<p>如果数据比较重要，并且在使用主从复制时关闭了主服务器持久化功能的场景中，都应该禁止实例自动重启。</p>
<h3 id="redis主从复制是如何工作的"><strong>Redis主从复制是如何工作的</strong></h3>
<p>如果设置了一个从服务器，在连接时它发送了一个SYNC命令，不管它是第一次连接还是再次连接都没有关系。</p>
<p>然后主服务器开始后台存储，并且开始缓存新连接进来的修改数据的命令。当后台存储完成后，主服务器把数据文件发送到从服务器，</p>
<p>从服务器将其保存在磁盘上，然后加载到内存中。然后主服务器把刚才缓存的命令发送到从服务器。这是作为命令流来完成的，并且</p>
<p>和Redis协议本身格式相同。</p>
<p>你可以通过telnet自己尝试一下。在Redis服务器工作时连接到Redis端口，发送SYNC命令，会看到一个批量的传输，并且主服务器接收</p>
<p>的每一个命令都会通过telnet会话重新发送一遍。</p>
<p>当主从服务器之间的连接由于某些原因断开时，从服务器可以自动进行重连接。当有多个从服务器同时请求同步时，主服务器只进行一个后台存储。</p>
<p>当连接断开又重新连上之后，一般都会进行一个完整的重新同步，但是从Redis2.8开始，只重新同步一部分也可以。</p>
<h3 id="部分重新同步"><strong>部分重新同步</strong></h3>
<p>从Redis 2.8开始，如果遭遇连接断开，重新连接之后可以从中断处继续进行复制，而不必重新同步。</p>
<p>它的工作原理是这样：</p>
<p>主服务器端为复制流维护一个内存缓冲区（in-memory backlog）。主从服务器都维护一个复制偏移量（replication offset）和master run id ，</p>
<p>当连接断开时，从服务器会重新连接上主服务器，然后请求继续复制，假如主从服务器的两个master run id相同，并且指定的偏移量在内存缓冲</p>
<p>区中还有效，复制就会从上次中断的点开始继续。如果其中一个条件不满足，就会进行完全重新同步（在2.8版本之前就是直接进行完全重新同步）。</p>
<p>因为主运行id不保存在磁盘中，如果从服务器重启了的话就只能进行完全同步了。</p>
<p>部分重新同步这个新特性内部使用PSYNC命令，旧的实现中使用SYNC命令。Redis2.8版本可以检测出它所连接的服务器是否支持PSYNC命令，不支持的</p>
<p>话使用SYNC命令。</p>
<h3 id="无磁盘复制"><strong>无磁盘复制</strong></h3>
<p>通常来讲，一个完全重新同步需要在磁盘上创建一个RDB文件，然后加载这个文件以便为从服务器发送数据。</p>
<p>如果使用比较低速的磁盘，这种操作会给主服务器带来较大的压力。Redis从2.8.18版本开始尝试支持无磁盘的复制。</p>
<p>使用这种设置时，子进程直接将RDB通过网络发送给从服务器，不使用磁盘作为中间存储。</p>
<h3 id="配置"><strong>配置</strong></h3>
<p>主从复制的配置十分简单：把下面这行加入到从服务器的配置文件中即可。</p>
<p>slaveof 192.168.1.1 6379</p>
<p>当然你需要把其中的192.168.1.1 6379替换为你自己的主服务器IP（或者主机名hostname）和端口。另外你可以调用SLAVEOF命令，</p>
<p>主服务器就会开始与从服务器同步。</p>
<p>关于部分重新同步，还有一些针对复制内存缓冲区的优化参数。查看Redis介质中的Redis.conf示例获得更多信息。</p>
<p>使用repl-diskless-sync配置参数来启动无磁盘复制。使用repl-diskless-sync-delay 参数来配置传输开始的延迟时间，以便等待</p>
<p>更多的从服务器连接上来。查看Redis介质中的Redis.conf示例获得更多信息。</p>
<h3 id="只读从服务器"><strong>只读从服务器</strong></h3>
<p>从Redis 2.6开始，从服务器支持只读模式，并且是默认模式。这个行为是由Redis.conf文件中的slave-read-only 参数控制的，</p>
<p>可以在运行中通过CONFIG SET来启用或者禁用。</p>
<p>只读的从服务器会拒绝所有写命令，所以对从服务器不会有误写操作。但这不表示可以把从服务器实例暴露在危险的网络环境下，</p>
<p>因为像DEBUG或者CONFIG这样的管理命令还是可以运行的。不过你可以通过使用rename-command命令来为这些命令改名来增加安全性。</p>
<p>你可能想知道为什么只读限制还可以被还原，使得从服务器还可以进行写操作。虽然当主从服务器进行重新同步或者从服务器重启后，</p>
<p>这些写操作都会失效，还是有一些使用场景会想从服务器中写入临时数据的，但将来这个特性可能会被去掉。</p>
<h3 id="限制有n个以上从服务器才允许写入"><strong>限制有N个以上从服务器才允许写入</strong></h3>
<p>从Redis 2.8版本开始，可以配置主服务器连接N个以上从服务器才允许对主服务器进行写操作。但是，因为Redis使用的是异步主从复制，</p>
<p>没办法确保从服务器确实收到了要写入的数据，所以还是有一定的数据丢失的可能性。</p>
<p>这一特性的工作原理如下：</p>
<p>1）从服务器每秒钟ping一次主服务器，确认处理的复制流数量。</p>
<p>2）主服务器记住每个从服务器最近一次ping的时间。</p>
<p>3）用户可以配置最少要有N个服务器有小于M秒的确认延迟。</p>
<p>4）如果有N个以上从服务器，并且确认延迟小于M秒，主服务器接受写操作。</p>
<p>还可以把这看做是CAP原则（一致性，可用性，分区容错性）不严格的一致性实现，虽然不能百分百确保一致性，但至少保证了丢失的数据不会超过M秒内的数据量。</p>
<p>如果条件不满足，主服务器会拒绝写操作并返回一个错误。</p>
<p>1）min-slaves-to-write（最小从服务器数）</p>
<p>2）min-slaves-max-lag（从服务器最大确认延迟）</p>
<h2 id="二-redis主从复制配置"><strong>二、</strong> <strong>Redis主从复制配置</strong></h2>
<h3 id="1参考文档"><strong>1.参考文档</strong></h3>
<p>文档地址：</p>
<p><a href="https://www.cnblogs.com/daofaziran/p/10978628.html">https://www.cnblogs.com/daofaziran/p/10978628.html</a></p>
<p>配置说明:</p>
<p><a href="https://www.cnblogs.com/kreo/p/4423362.html">https://www.cnblogs.com/kreo/p/4423362.html</a></p>
<h3 id="2主从配置"><strong>2.主从配置</strong></h3>
<p>#从服务增加配置</p>
<p>slaveof 192.168.1.1 6379</p>
<h3 id="3一些常用配置"><strong>3.一些常用配置:</strong></h3>
<h4 id="redis-defaultconf-作为基础配置供其他配置文件引用"><strong>redis-default.conf 作为基础配置,供其他配置文件引用</strong></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">bind</span> 127.0.0.1

protected-mode yes

port <span class="m">6379</span>

tcp-backlog <span class="m">511</span>

timeout <span class="m">0</span>

tcp-keepalive <span class="m">300</span>

daemonize yes

supervised no

pidfile /var/run/redis_6379.pid

loglevel notice

logfile <span class="s2">&#34;/var/log/redis/redis_6379.log&#34;</span>

databases <span class="m">16</span>

 

always-show-logo yes

 

<span class="c1">#RDB</span>

<span class="c1">#save 900 1</span>

<span class="c1">#save 300 10</span>

<span class="c1">#save 60 10000</span>

<span class="c1">#stop-writes-on-bgsave-error yes</span>

<span class="c1">#rdbcompression yes</span>

<span class="c1">#rdbchecksum no</span>

<span class="c1">#dbfilename dump.rdb</span>

<span class="c1">#dir ./</span>

 

<span class="c1">#masterauth dy123456</span>

slave-serve-stale-data yes

slave-read-only yes

repl-diskless-sync no

repl-diskless-sync-delay <span class="m">5</span>

repl-disable-tcp-nodelay no

slave-priority <span class="m">100</span>

<span class="c1">#requirepass dy123456</span>

maxclients <span class="m">10000</span>

lazyfree-lazy-eviction no

lazyfree-lazy-expire no

lazyfree-lazy-server-del no

slave-lazy-flush no

 

<span class="c1">#AOF</span>

appendonly no

appendfilename <span class="s2">&#34;appendonly.aof&#34;</span>

appendfsync everysec

no-appendfsync-on-rewrite no

auto-aof-rewrite-percentage <span class="m">100</span>

auto-aof-rewrite-min-size 64mb

aof-load-truncated yes

aof-use-rdb-preamble no

 

lua-time-limit <span class="m">5000</span>

slowlog-log-slower-than <span class="m">10000</span>

slowlog-max-len <span class="m">128</span>

latency-monitor-threshold <span class="m">0</span>

notify-keyspace-events <span class="s2">&#34;&#34;</span>

hash-max-ziplist-entries <span class="m">512</span>

hash-max-ziplist-value <span class="m">64</span>

list-max-ziplist-size -2

list-compress-depth <span class="m">0</span>

set-max-intset-entries <span class="m">512</span>

zset-max-ziplist-entries <span class="m">128</span>

zset-max-ziplist-value <span class="m">64</span>

hll-sparse-max-bytes <span class="m">3000</span>

activerehashing yes

client-output-buffer-limit normal <span class="m">0</span> <span class="m">0</span> <span class="m">0</span>

client-output-buffer-limit slave 256mb 64mb <span class="m">60</span>

client-output-buffer-limit pubsub 32mb 8mb <span class="m">60</span>

hz <span class="m">10</span>

aof-rewrite-incremental-fsync yes
</code></pre></td></tr></table>
</div>
</div><h4 id="单机版redis-singleconf-配置"><strong>单机版redis-single.conf 配置</strong></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">#导入基础配置</span>

include redis-default.conf

<span class="c1">#根目录,建议配置成绝对路径,这样下面的file都可以配置成相对路径</span>

dir ./

<span class="c1">#守护方式启动</span>

daemonize yes

<span class="c1">#守护方式PID存放路径</span>

pidfile /var/run/redis_6379.pid

<span class="c1">#绑定的客户端地址</span>

<span class="nb">bind</span> 0.0.0.0

<span class="c1">#启动端口</span>

port <span class="m">6379</span>

<span class="c1">#tcp队列长度(不能超过somaxconn和tcp_max_syn_backlog的值)</span>

tcp-backlog <span class="m">4096</span>

<span class="c1">#客户端闲置关闭时间,0代表不关闭</span>

timeout <span class="m">300</span>

<span class="c1">#检测时间,空闲则关闭</span>

tcp-keepalive <span class="m">60</span>

<span class="c1">#日志级别 debug/verbose:适用于开发和调试 notice:适用于生产模式 warning:只打印警告</span>

loglevel notice

<span class="c1">#日志文件stdout是标准输出(输出屏幕或者发送给dev/null)</span>

logfile <span class="s2">&#34;/var/log/redis/redis_6379.log&#34;</span>

logfile stdout

<span class="c1">#数据库访问密码</span>

requirepass dy123456

<span class="c1">#最大连接数 0代表不限制</span>

maxclients <span class="m">10000</span>

<span class="c1">#最大内存限制maxmemory bytes</span>

<span class="c1">#maxmemory 16777216</span>

<span class="c1">#开启RDB 每60分钟备份一次</span>

save <span class="m">3600</span> <span class="m">1</span>

<span class="c1">#开启AOF</span>

appendonly yes

<span class="c1">#AOF文件位置</span>

appendfilename <span class="s2">&#34;appendonly.aof&#34;</span>

<span class="c1">#每秒备份</span>

appendfsync everysec

<span class="c1">#开启混合备份模式</span>

aof-use-rdb-preamble yes

<span class="c1">#混合模式RDB备份时机 ,默认是文件到达64M即进行重写</span>

auto-aof-rewrite-percentage <span class="m">100</span>

auto-aof-rewrite-min-size 128mb

 

<span class="c1">#禁用危险命令</span>

rename-command FLUSHALL <span class="s2">&#34;nkGqnnmrnES22sA0KI9KVP18TToAhbwP&#34;</span>

rename-command FLUSHDB <span class="s2">&#34;3h0Y2uVnENarfbF8tHtVrP4Q1PUXZnU8&#34;</span>

rename-command KEYS <span class="s2">&#34;Rq1iyHHsPfUam9w9XkBQ5mhRERI01YIs&#34;</span>

rename-command CONFIG <span class="s2">&#34;9jgj3ETHylbxczuJT6Kp6GSHuNdJB1xd&#34;</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="集群配置redis-clusterconf--在单机版的配置下--增加集群配置"><strong>集群配置redis-cluster.conf , 在单机版的配置下 , 增加集群配置</strong></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">#导入单机配置</span>

include redis-single.conf

 

<span class="c1">#启用集群模式</span>

cluster-enabled yes

<span class="c1">#集群启动后存放节点的文件</span>

cluster-config-file nodes_6379.conf

<span class="c1">#节点连接超时时间</span>

cluster-node-timeout <span class="m">5000</span> 

<span class="c1">#集群访问密码,一般和数据库访问密码一致</span>

masterauth dy123456

</code></pre></td></tr></table>
</div>
</div><h4 id="完整redisconf配置"><strong>完整redis.conf配置</strong></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">#bind 127.0.0.1</span>

<span class="c1">#绑定的IP</span>

<span class="nb">bind</span> 0.0.0.0

<span class="c1">#安全模式</span>

protected-mode yes

<span class="c1">#启动端口</span>

port <span class="m">6379</span>

<span class="c1">#tcp队列长度(不能超过somaxconn和tcp_max_syn_backlog的值)</span>

tcp-backlog <span class="m">4096</span>

<span class="c1">#客户端闲置关闭时间,0代表不关闭</span>

timeout <span class="m">300</span>

<span class="c1">#检测时间,空闲则关闭</span>

tcp-keepalive <span class="m">60</span>

<span class="c1">#守护方式启动</span>

daemonize yes

<span class="c1">#supervised</span>

supervised no

<span class="c1">#守护方式PID存放路径</span>

pidfile /var/run/redis_6379.pid

<span class="c1">#日志级别 debug/verbose:适用于开发和调试 notice:适用于生产模式 warning:只打印警告</span>

loglevel notice

<span class="c1">#日志文件stdout是标准输出(输出屏幕或者发送给dev/null)</span>

logfile <span class="s2">&#34;/var/log/redis/redis_6379.log&#34;</span>

logfile stdout

<span class="c1">#数据库数量</span>

databases <span class="m">16</span>

<span class="c1">#数据库访问密码</span>

requirepass dy123456

 

always-show-logo yes

 

<span class="c1">#开启RDB 每60分钟备份一次</span>

save <span class="m">3600</span> <span class="m">1</span>

<span class="c1">#RDB</span>

<span class="c1">#save 900 1</span>

<span class="c1">#save 300 10</span>

<span class="c1">#save 60 10000</span>

<span class="c1">#stop-writes-on-bgsave-error yes</span>

<span class="c1">#rdbcompression yes</span>

<span class="c1">#rdbchecksum no</span>

<span class="c1">#dbfilename dump.rdb</span>

<span class="c1">#根目录,建议配置成绝对路径,这样下面的file都可以配置成相对路径</span>

dir ./

 

slave-serve-stale-data yes

slave-read-only yes

repl-diskless-sync no

repl-diskless-sync-delay <span class="m">5</span>

repl-disable-tcp-nodelay no

slave-priority <span class="m">100</span>

<span class="c1">#最大连接数 0代表不限制</span>

maxclients <span class="m">10000</span>

<span class="c1">#最大内存限制maxmemory bytes</span>

<span class="c1">#maxmemory 16777216</span>

lazyfree-lazy-eviction no

lazyfree-lazy-expire no

lazyfree-lazy-server-del no

slave-lazy-flush no

 

<span class="c1">#开启AOF</span>

appendonly yes

<span class="c1">#AOF文件位置</span>

appendfilename <span class="s2">&#34;appendonly.aof&#34;</span>

<span class="c1">#每秒备份</span>

appendfsync everysec

<span class="c1">#开启混合备份模式</span>

aof-use-rdb-preamble yes

<span class="c1">#混合模式RDB备份时机 ,默认是文件到达64M即进行重写</span>

auto-aof-rewrite-percentage <span class="m">100</span>

auto-aof-rewrite-min-size 128mb

<span class="c1">#AOF</span>

no-appendfsync-on-rewrite no

aof-load-truncated yes

 

lua-time-limit <span class="m">5000</span>

slowlog-log-slower-than <span class="m">10000</span>

slowlog-max-len <span class="m">128</span>

latency-monitor-threshold <span class="m">0</span>

notify-keyspace-events <span class="s2">&#34;&#34;</span>

hash-max-ziplist-entries <span class="m">512</span>

hash-max-ziplist-value <span class="m">64</span>

list-max-ziplist-size -2

list-compress-depth <span class="m">0</span>

set-max-intset-entries <span class="m">512</span>

zset-max-ziplist-entries <span class="m">128</span>

zset-max-ziplist-value <span class="m">64</span>

hll-sparse-max-bytes <span class="m">3000</span>

activerehashing yes

client-output-buffer-limit normal <span class="m">0</span> <span class="m">0</span> <span class="m">0</span>

client-output-buffer-limit slave 256mb 64mb <span class="m">60</span>

client-output-buffer-limit pubsub 32mb 8mb <span class="m">60</span>

hz <span class="m">10</span>

aof-rewrite-incremental-fsync yes

 

<span class="c1">#禁用危险命令</span>

rename-command FLUSHALL <span class="s2">&#34;nkGqnnmrnES22sA0KI9KVP18TToAhbwP&#34;</span>

rename-command FLUSHDB <span class="s2">&#34;3h0Y2uVnENarfbF8tHtVrP4Q1PUXZnU8&#34;</span>

rename-command KEYS <span class="s2">&#34;Rq1iyHHsPfUam9w9XkBQ5mhRERI01YIs&#34;</span>

rename-command CONFIG <span class="s2">&#34;9jgj3ETHylbxczuJT6Kp6GSHuNdJB1xd&#34;</span>

 

<span class="c1">#启用集群模式</span>

<span class="c1">#cluster-enabled yes</span>

<span class="c1">#集群启动后存放节点的文件</span>

<span class="c1">#cluster-config-file nodes_6379.conf</span>

<span class="c1">#节点连接超时时间</span>

<span class="c1">#cluster-node-timeout 5000</span>

<span class="c1">#集群访问密码,一般和数据库访问密码一致</span>

<span class="c1">#masterauth dy123456</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="sentinelconf配置"><strong>sentinel.conf配置</strong></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># bind 127.0.0.1</span>

<span class="nb">bind</span> 0.0.0.0

 

<span class="c1"># 哨兵的端口号</span>

<span class="c1"># 因为各个哨兵节点会运行在单独的Docker容器中</span>

<span class="c1"># 所以无需担心端口重复使用</span>

<span class="c1"># 如果需要在单机</span>

port <span class="m">26379</span>

 

<span class="c1">#安全模式</span>

protected-mode no

 

<span class="c1"># 设定密码认证</span>

requirepass dy123456

 

<span class="c1">#后台运行</span>

daemonize yes

 

<span class="c1"># 配置哨兵的监控参数</span>

<span class="c1"># 格式：sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</span>

<span class="c1"># master-name是为这个被监控的master起的名字</span>

<span class="c1"># ip是被监控的master的IP或主机名。因为Docker容器之间可以使用容器名访问，所以这里写master节点的容器名</span>

<span class="c1"># redis-port是被监控节点所监听的端口号</span>

<span class="c1"># quorom设定了当几个哨兵判定这个节点失效后，才认为这个节点真的失效了</span>

sentinel monitor redis_6379 172.18.0.2 <span class="m">6379</span> <span class="m">1</span>

 

<span class="c1"># 连接主节点的密码</span>

<span class="c1"># 格式：sentinel auth-pass &lt;master-name&gt; &lt;password&gt;</span>

sentinel auth-pass redis_6379 dy123456

 

<span class="c1"># master在连续多长时间无法响应PING指令后，就会主观判定节点下线，默认是30秒</span>

<span class="c1"># 格式：sentinel down-after-milliseconds &lt;master-name&gt; &lt;milliseconds&gt;</span>

sentinel down-after-milliseconds redis_6379 <span class="m">30000</span>

sentinel failover-timeout redis_6379 <span class="m">180000</span>

sentinel parallel-syncs redis_6379 <span class="m">1</span>

 

<span class="c1"># 数据文件</span>

dir ./

 

<span class="c1"># 日志和接口</span>

logfile <span class="s2">&#34;/var/log/redis/sentinel_26379.log&#34;</span>

pidfile /var/run/redis_26379.pid
</code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">ZhangKQ</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2019-08-07
        
    </span>
  </p>
  
  
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/qrcode/wechat-qr-code.jpg">
        <span>微信打赏</span>
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="/qrcode/alipay-qr-code.jpg">
        <span>支付宝打赏</span>
      </label>
  </div>
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
          <a href="/tags/redis/">redis</a>
          <a href="/tags/cache/">cache</a>
          <a href="/tags/no-sql/">no sql</a>
          <a href="/tags/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/">主从复制</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/cache/redis-docker%E9%83%A8%E7%BD%B2%E5%8F%8A%E9%85%8D%E7%BD%AE/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">[数据库] Redis-Docker部署及主从复制配置</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/php/mongodb/mongodb%E4%B9%8Bphp%E7%9A%84%E4%BD%BF%E7%94%A8gridfs/">
            <span class="next-text nav-default">[MongoDB]MongoDB之PHP的使用(GridFs)</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:wdyxzkq@163.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/dysoso" class="iconfont icon-github" title="github"></a>
      <a href="https://gitee.com/dysoso" class="iconfont icon-gitlab" title="gitlab"></a>
  <a href="https://blog.nevergiveup.tech/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://blog.nevergiveup.tech/">blog.nevergiveup.tech</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span><a href="https://beian.miit.gov.cn/">蜀ICP备2021005948号-1</a></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'never-give-up', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
